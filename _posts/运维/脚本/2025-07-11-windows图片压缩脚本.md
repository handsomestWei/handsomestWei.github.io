---
title: windowså›¾ç‰‡å‹ç¼©è„šæœ¬
date: 2025-07-11 23:00:00
categories: [è¿ç»´, è„šæœ¬]
tags: [è¿ç»´, è„šæœ¬, powershell]
image:
  path: /assets/img/posts/common/powershell.jpg
---

# windowså›¾ç‰‡å‹ç¼©è„šæœ¬

## æ¦‚è¿°

`compress-images.ps1` æ˜¯ä¸€ä¸ª PowerShell è„šæœ¬ï¼Œç”¨äºè‡ªåŠ¨å‹ç¼©ä¸­æŒ‡å®šç›®å½•ä¸‹çš„å›¾ç‰‡æ–‡ä»¶ï¼Œå°†å¤§äºæŒ‡å®šå¤§å°çš„å›¾ç‰‡å‹ç¼©åˆ°ç›®æ ‡å¤§å°ä»¥å†…ï¼Œå¯ç”¨äºä¼˜åŒ–åšå®¢ç­‰ç½‘ç«™åŠ è½½é€Ÿåº¦ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ” **è‡ªåŠ¨æ‰«æ**: é€’å½’æ‰«ææŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶
- ğŸ“ **æ™ºèƒ½å‹ç¼©**: é€šè¿‡è°ƒæ•´å›¾ç‰‡è´¨é‡å’Œå°ºå¯¸å®ç°å‹ç¼©
- ğŸ”„ **å¤šæ¬¡å°è¯•**: è‡ªåŠ¨é™ä½è´¨é‡ç›´åˆ°è¾¾åˆ°ç›®æ ‡å¤§å°
- ğŸ’¾ **å®‰å…¨å¤‡ä»½**: è‡ªåŠ¨åˆ›å»ºå¤‡ä»½ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨æ¢å¤
- ğŸ¯ **ç²¾ç¡®æ§åˆ¶**: æ”¯æŒè‡ªå®šä¹‰ç›®æ ‡æ–‡ä»¶å¤§å°
- ğŸ“Š **è¯¦ç»†æŠ¥å‘Š**: æ˜¾ç¤ºå‹ç¼©å‰åçš„æ–‡ä»¶å¤§å°å¯¹æ¯”

## ç³»ç»Ÿè¦æ±‚

- Windows 10/11
- PowerShell 5.1+
- .NET Frameworkï¼ˆç³»ç»Ÿè‡ªå¸¦ï¼‰

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```powershell
# ä½¿ç”¨é»˜è®¤è®¾ç½®å‹ç¼©å›¾ç‰‡
powershell -ExecutionPolicy Bypass -File "compress-images.ps1"
```

### è‡ªå®šä¹‰å‚æ•°

å¦‚éœ€ä¿®æ”¹å‹ç¼©å‚æ•°ï¼Œè¯·ç¼–è¾‘è„šæœ¬ä¸­çš„ä»¥ä¸‹å˜é‡ï¼š

```powershell
$ImagePath = "/img  # å›¾ç‰‡ç›®å½•è·¯å¾„
$MaxSizeKB = 30                        # ç›®æ ‡æ–‡ä»¶å¤§å°ï¼ˆKBï¼‰
```

### æ‰§è¡Œç­–ç•¥è¯´æ˜

å¦‚æœé‡åˆ°æ‰§è¡Œç­–ç•¥é™åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š

```powershell
# æ–¹å¼1ï¼šç»•è¿‡æ‰§è¡Œç­–ç•¥ï¼ˆæ¨èï¼‰
powershell -ExecutionPolicy Bypass -File "compress-images.ps1"

# æ–¹å¼2ï¼šä¸´æ—¶ä¿®æ”¹æ‰§è¡Œç­–ç•¥
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
.\compress-images.ps1
```

## å‹ç¼©ç­–ç•¥

### æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
- JPG/JPEG
- PNG

### å‹ç¼©ç®—æ³•
1. **å°ºå¯¸è°ƒæ•´**: å°†å›¾ç‰‡ç¼©æ”¾åˆ°æœ€å¤§ 800Ã—600 åƒç´ ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰
2. **è´¨é‡å‹ç¼©**: ä»è´¨é‡ 60 å¼€å§‹ï¼Œæ¯æ¬¡é™ä½ 10ï¼Œæœ€ä½åˆ° 10
3. **æ™ºèƒ½é€‰æ‹©**: é€‰æ‹©æ»¡è¶³å¤§å°è¦æ±‚çš„æœ€ä½è´¨é‡è®¾ç½®

### å®‰å…¨æœºåˆ¶
- è‡ªåŠ¨åˆ›å»º `.backup` å¤‡ä»½æ–‡ä»¶
- å‹ç¼©å¤±è´¥æ—¶è‡ªåŠ¨æ¢å¤åŸå›¾
- èµ„æºè‡ªåŠ¨é‡Šæ”¾ï¼Œé¿å…æ–‡ä»¶å ç”¨

## æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½é‡è¦**: è„šæœ¬ä¼šè‡ªåŠ¨å¤‡ä»½åŸå›¾ï¼Œä½†å»ºè®®åœ¨è¿è¡Œå‰æ‰‹åŠ¨å¤‡ä»½é‡è¦å›¾ç‰‡
2. **ä¸å¯é€†**: å‹ç¼©åçš„å›¾ç‰‡ä¼šæ›¿æ¢åŸå›¾ï¼Œè¯·ç¡®ä¿æœ‰å¤‡ä»½
3. **è´¨é‡æŸå¤±**: å‹ç¼©ä¼šé™ä½å›¾ç‰‡è´¨é‡ï¼Œè¯·æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´å‚æ•°
4. **æ–‡ä»¶å ç”¨**: ç¡®ä¿å›¾ç‰‡æ–‡ä»¶æ²¡æœ‰è¢«å…¶ä»–ç¨‹åºæ‰“å¼€

## å®Œæ•´è„šæœ¬ä»£ç 

```powershell
# Image compression script
# Compress images to under 30KB

$ImagePath = "/img"
$MaxSizeKB = 30

# Add System.Drawing assembly
Add-Type -AssemblyName System.Drawing

function Compress-Image {
    param(
        [string]$FilePath,
        [int]$MaxSizeKB
    )
    
    try {
        $file = Get-Item $FilePath
        $originalSizeKB = [math]::Round($file.Length / 1KB, 1)
        
        Write-Host "Processing: $($file.Name) - Original size: ${originalSizeKB}KB"
        
        if ($originalSizeKB -le $MaxSizeKB) {
            Write-Host "  Skip - already under ${MaxSizeKB}KB" -ForegroundColor Green
            return
        }
        
        # Create backup
        $backupPath = $FilePath + ".backup"
        Copy-Item $FilePath $backupPath -Force
        
        # Load image
        $image = [System.Drawing.Image]::FromFile($FilePath)
        
        # Calculate new dimensions
        $maxWidth = 800
        $maxHeight = 600
        
        $ratio = [Math]::Min($maxWidth / $image.Width, $maxHeight / $image.Height)
        $newWidth = [int]($image.Width * $ratio)
        $newHeight = [int]($image.Height * $ratio)
        if ($ratio -ge 1) {
            $newWidth = $image.Width
            $newHeight = $image.Height
        }
        
        # Create new bitmap
        $bitmap = New-Object System.Drawing.Bitmap($newWidth, $newHeight)
        $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
        
        # Set high quality interpolation
        $graphics.InterpolationMode = [System.Drawing.Drawing2D.InterpolationMode]::HighQualityBicubic
        $graphics.DrawImage($image, 0, 0, $newWidth, $newHeight)
        
        # Try multiple compressions with decreasing quality
        $success = $false
        for ($quality = 60; $quality -ge 10; $quality -= 10) {
            $tempFile = $FilePath + ".tmp"
            $encoder = [System.Drawing.Imaging.ImageCodecInfo]::GetImageDecoders() | Where-Object { $_.FormatID -eq [System.Drawing.Imaging.ImageFormat]::JPEG.Guid }
            $encoderParams = New-Object System.Drawing.Imaging.EncoderParameters(1)
            $encoderParams.Param[0] = New-Object System.Drawing.Imaging.EncoderParameter([System.Drawing.Imaging.Encoder]::Quality, [long]$quality)
            $bitmap.Save($tempFile, $encoder, $encoderParams)
            $compressedSizeKB = [math]::Round((Get-Item $tempFile).Length / 1KB, 1)
            if ($compressedSizeKB -le $MaxSizeKB) {
                $success = $true
                break
            }
            Remove-Item $tempFile -Force
        }
        
        # Clean up resources
        $graphics.Dispose()
        $bitmap.Dispose()
        $image.Dispose()
        
        if ($success) {
            Remove-Item $FilePath -Force
            Move-Item $tempFile $FilePath -Force
            $finalSizeKB = [math]::Round((Get-Item $FilePath).Length / 1KB, 1)
            Write-Host "  Success: ${finalSizeKB}KB (reduced ${($originalSizeKB - $finalSizeKB):F1}KB)" -ForegroundColor Green
            Remove-Item $backupPath
        } else {
            Write-Host "  Still too large after all attempts" -ForegroundColor Yellow
            Copy-Item $backupPath $FilePath -Force
            Remove-Item $backupPath
        }
        
    } catch {
        Write-Host "  Failed: $($_.Exception.Message)" -ForegroundColor Red
        if (Test-Path $backupPath) {
            Copy-Item $backupPath $FilePath -Force
            Remove-Item $backupPath
        }
    }
}

# Get all image files (fix: use -Recurse and -File, and correct -Include usage)
$imageFiles = Get-ChildItem $ImagePath -Recurse -File | Where-Object { ($_.Extension -match "jpg|jpeg|png") -and ($_.Length / 1KB -gt $MaxSizeKB) }

Write-Host "Found $($imageFiles.Count) images larger than ${MaxSizeKB}KB" -ForegroundColor Cyan

foreach ($file in $imageFiles) {
    Compress-Image -FilePath $file.FullName -MaxSizeKB $MaxSizeKB
}

Write-Host "Compression completed!" -ForegroundColor Green
```